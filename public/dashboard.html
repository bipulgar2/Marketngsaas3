<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgencyOS | SEO Agency Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'Inter', 'sans-serif'],
                    },
                    colors: {
                        gray: {
                            900: '#111827',
                            950: '#0B0F19',
                        },
                        violet: {
                            500: '#8B5CF6',
                            600: '#7C3AED',
                        },
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap');

        html {
            font-size: 13px;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #0B0F19;
        }

        .top-tab {
            padding: 0.5rem 1rem;
            border-bottom: 2px solid transparent;
        }

        .top-tab.active {
            border-bottom-color: #8B5CF6;
            color: white;
        }

        .top-tab:hover {
            color: white;
        }

        .side-tab {
            padding: 0.5rem 0.75rem;
            border-left: 2px solid transparent;
        }

        .side-tab.active {
            border-left-color: #8B5CF6;
            background: rgba(139, 92, 246, 0.1);
            color: white;
        }

        .side-tab:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0B0F19;
        }

        ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 3px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.15s ease-out forwards;
        }
    </style>
</head>

<body class="bg-gray-950 text-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- Top Header Bar -->
    <header class="bg-gray-900 border-b border-gray-800 shrink-0">
        <div class="flex items-center justify-between px-4 h-12">
            <!-- Logo -->
            <div class="flex items-center gap-2">
                <div class="bg-gradient-to-r from-violet-600 to-indigo-600 p-1.5 rounded-lg">
                    <i data-lucide="brain-circuit" class="w-4 h-4 text-white"></i>
                </div>
                <span class="text-sm font-bold text-white">Agency<span class="text-violet-500">OS</span></span>
            </div>

            <!-- Top Tabs -->
            <nav class="flex items-center gap-1" id="topTabs">
                <!-- Populated by JS -->
            </nav>

            <!-- Right Side: Client Selector + New Client -->
            <div class="flex items-center gap-3">
                <select id="clientSelector" onchange="selectClient(this.value)"
                    class="bg-gray-800 border border-gray-700 text-white text-sm rounded-lg px-3 py-1.5 focus:border-violet-500 focus:outline-none min-w-[200px]">
                    <option value="">Select Client...</option>
                </select>
                <button onclick="showNewClientModal()"
                    class="bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-500 hover:to-indigo-500 text-white px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1.5">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    New Client
                </button>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex-1 flex overflow-hidden">
        <!-- Left Sidebar (Side Tabs) -->
        <aside class="w-48 bg-gray-900 border-r border-gray-800 flex flex-col shrink-0">
            <div class="p-3 border-b border-gray-800">
                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider" id="sidebarTitle">Navigation</p>
            </div>
            <nav class="flex-1 p-2 space-y-1 overflow-y-auto" id="sideTabs">
                <!-- Populated by JS -->
            </nav>

            <!-- User Info -->
            <div class="p-3 border-t border-gray-800">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-7 h-7 rounded-full bg-gradient-to-r from-violet-600 to-indigo-600 flex items-center justify-center text-white text-xs font-bold"
                        id="userAvatar">?</div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-white truncate" id="userName">Loading...</p>
                        <p class="text-xs text-gray-400 truncate" id="userRole">--</p>
                    </div>
                </div>
                <div class="px-2 pb-3 pt-1 space-y-1">
                    <button onclick="showUserSettingsModal()"
                        class="w-full flex items-center justify-center gap-1.5 px-2 py-1.5 text-xs text-gray-400 hover:text-white hover:bg-gray-800 rounded transition-colors">
                        <i data-lucide="settings" class="w-3 h-3"></i> Settings
                    </button>
                    <button onclick="logout()"
                        class="w-full flex items-center justify-center gap-1.5 px-2 py-1.5 text-xs text-gray-400 hover:text-red-400 hover:bg-gray-800 rounded transition-colors">
                        <i data-lucide="log-out" class="w-3 h-3"></i> Logout
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Content Header -->
            <div class="h-12 bg-gray-900/50 border-b border-gray-800 flex items-center justify-between px-6 shrink-0">
                <h1 class="text-base font-semibold text-white" id="pageTitle">Dashboard</h1>
                <div class="flex items-center gap-2" id="pageActions">
                    <!-- Actions populated by JS -->
                </div>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-6" id="contentArea">
                <div class="flex items-center justify-center h-full text-gray-500">
                    <i data-lucide="loader-2" class="w-5 h-5 animate-spin mr-2"></i> Loading...
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50">
        <div id="modalContent"
            class="bg-gray-900 border border-gray-700 rounded-xl w-full max-w-lg shadow-2xl animate-fade-in">
        </div>
    </div>

    <script>
        // =========================================================================
        // STATE
        // =========================================================================
        let currentUser = null;
        let currentClient = null;
        let currentTopTab = 'dashboard';
        let currentSideTab = 'overview';
        let clients = [];
        let activeAudit = null; // Store currently viewed audit

        // =========================================================================
        // TAB CONFIGURATION
        // =========================================================================
        const TOP_TABS = [
            { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
            { id: 'tech-audit', label: 'Tech Audit', icon: 'search-code' },
            { id: 'content', label: 'Content', icon: 'file-text' },
            { id: 'keywords', label: 'Keywords', icon: 'key' },
            { id: 'competitors', label: 'Competitors', icon: 'users' },
            { id: 'links', label: 'Links', icon: 'link' },
            { id: 'tasks', label: 'Tasks', icon: 'check-square' },
            { id: 'reports', label: 'Reports', icon: 'bar-chart-2' },
            { id: 'client-settings', label: 'Settings', icon: 'settings', clientOnly: true }
        ];

        const SIDE_TABS = {
            'dashboard': [
                { id: 'overview', label: 'Overview' },
                { id: 'clients', label: 'All Clients' },
                { id: 'team', label: 'Team' },
                { id: 'settings', label: 'Settings' }
            ],
            'tech-audit': [
                { id: 'url-inspection', label: 'URL Inspection' },
                { id: 'on-page', label: 'On-Page Report' },
                { id: 'technical-issues', label: 'Technical Issues' },
                { id: 'core-vitals', label: 'Core Web Vitals' },
                { id: 'schema', label: 'Schema Markup' },
                { id: 'page-speed', label: 'Page Speed' }
            ],
            'content': [
                { id: 'briefs', label: 'Briefs' },
                { id: 'drafts', label: 'Drafts' },
                { id: 'published', label: 'Published' },
                { id: 'calendar', label: 'Calendar' },
                { id: 'templates', label: 'Templates' }
            ],
            'keywords': [
                { id: 'research', label: 'Research' },
                { id: 'clusters', label: 'Topic Clusters' },
                { id: 'tracking', label: 'Rank Tracking' },
                { id: 'opportunities', label: 'Opportunities' },
                { id: 'intent-map', label: 'Intent Map' }
            ],
            'competitors': [
                { id: 'overview', label: 'Competitors' },
                { id: 'content-gap', label: 'Content Gap' },
                { id: 'backlink-gap', label: 'Backlink Gap' },
                { id: 'content-library', label: 'Their Content' },
                { id: 'strategy', label: 'Strategy' }
            ],
            'links': [
                { id: 'backlink-profile', label: 'Backlink Profile' },
                { id: 'inventory', label: 'Link Inventory' },
                { id: 'placements', label: 'Placements' },
                { id: 'anchor-planner', label: 'Anchor Planner' },
                { id: 'prospects', label: 'Prospects' }
            ],
            'tasks': [
                { id: 'all-tasks', label: 'All Tasks' },
                { id: 'by-type', label: 'By Type' },
                { id: 'by-assignee', label: 'By Assignee' },
                { id: 'kanban', label: 'Kanban Board' },
                { id: 'my-tasks', label: 'My Tasks' }
            ],
            'reports': [
                { id: 'generated', label: 'Generated Reports' },
                { id: 'create', label: 'Create Report' },
                { id: 'analytics', label: 'Analytics' },
                { id: 'wins', label: 'Wins' },
                { id: 'exports', label: 'Exports' }
            ],
            'client-settings': [
                { id: 'general', label: 'General' },
                { id: 'google', label: 'Google (GSC, GA4)' },
                { id: 'cms', label: 'CMS Access' },
                { id: 'analytics', label: 'Analytics Tools' }
            ]
        };

        // =========================================================================
        // INIT
        // =========================================================================
        async function init() {
            try {
                const response = await fetch('/api/auth/me');
                if (!response.ok) {
                    window.location.href = '/login.html';
                    return;
                }

                const data = await response.json();
                currentUser = data.user;

                // Reset active audit on full reload
                activeAudit = null;

                // Update user info
                document.getElementById('userName').textContent = currentUser.full_name || currentUser.email.split('@')[0];
                document.getElementById('userRole').textContent = data.role_info?.name || currentUser.role;
                document.getElementById('userAvatar').textContent = (currentUser.full_name || currentUser.email)[0].toUpperCase();

                // Build UI
                buildTopTabs();
                buildSideTabs();
                await loadClients();
                loadContent();

                lucide.createIcons();
            } catch (error) {
                console.error('Init error:', error);
                window.location.href = '/login.html';
            }
        }

        // =========================================================================
        // BUILD UI
        // =========================================================================
        function buildTopTabs() {
            const container = document.getElementById('topTabs');
            // Filter out client-only tabs when no client is selected
            const visibleTabs = TOP_TABS.filter(tab => !tab.clientOnly || currentClient);
            container.innerHTML = visibleTabs.map(tab => `
                <button onclick="switchTopTab('${tab.id}')" 
                    class="top-tab flex items-center gap-1.5 text-sm text-gray-400 transition-colors ${tab.id === currentTopTab ? 'active' : ''}">
                    <i data-lucide="${tab.icon}" class="w-4 h-4"></i>
                    ${tab.label}
                </button>
            `).join('');
            lucide.createIcons();
        }

        function buildSideTabs() {
            const container = document.getElementById('sideTabs');
            const tabs = SIDE_TABS[currentTopTab] || [];
            const titleMap = {
                'dashboard': 'Dashboard',
                'tech-audit': 'Tech Issues',
                'content': 'Content',
                'keywords': 'Keywords',
                'competitors': 'Competitors',
                'links': 'Links',
                'tasks': 'Tasks',
                'reports': 'Reports',
                'client-settings': 'Client Settings'
            };

            document.getElementById('sidebarTitle').textContent = titleMap[currentTopTab] || 'Navigation';

            container.innerHTML = tabs.map(tab => `
                <button onclick="switchSideTab('${tab.id}')" 
                    class="side-tab w-full text-left text-sm text-gray-400 rounded transition-colors ${tab.id === currentSideTab ? 'active' : ''}">
                    ${tab.label}
                </button>
            `).join('');
        }

        // =========================================================================
        // NAVIGATION
        // =========================================================================
        function switchTopTab(tabId) {
            currentTopTab = tabId;
            currentSideTab = SIDE_TABS[tabId]?.[0]?.id || 'overview';
            buildTopTabs();
            buildSideTabs();
            loadContent();
        }

        function switchSideTab(tabId) {
            currentSideTab = tabId;
            buildSideTabs();
            loadContent();
        }

        // =========================================================================
        // CLIENT SELECTOR
        // =========================================================================
        async function loadClients() {
            try {
                const response = await fetch('/api/campaigns');
                const data = await response.json();
                clients = data.campaigns || [];

                const selector = document.getElementById('clientSelector');
                selector.innerHTML = '<option value="">Select Client...</option>' +
                    clients.map(c => `<option value="${c.id}">${c.name} (${c.domain})</option>`).join('');

                // Restore selected client from URL
                const params = new URLSearchParams(window.location.search);
                const clientId = params.get('client');
                if (clientId) {
                    selector.value = clientId;
                    currentClient = clients.find(c => c.id === clientId);
                    // Rebuild tabs to show client-only tabs (like Settings)
                    buildTopTabs();
                }
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        function selectClient(clientId, skipReload = false) {
            currentClient = clients.find(c => c.id === clientId) || null;

            // Update URL
            const url = new URL(window.location);
            if (clientId) {
                url.searchParams.set('client', clientId);
            } else {
                url.searchParams.delete('client');
            }
            window.history.pushState({}, '', url);

            // Only reload if not being chained with another navigation action
            if (!skipReload) {
                loadContent();
            }
        }

        // =========================================================================
        // CONTENT LOADING
        // =========================================================================
        async function loadContent() {
            const contentArea = document.getElementById('contentArea');
            const pageTitle = document.getElementById('pageTitle');
            const pageActions = document.getElementById('pageActions');

            // Show loading
            contentArea.innerHTML = `<div class="flex items-center justify-center h-32 text-gray-500">
                <i data-lucide="loader-2" class="w-5 h-5 animate-spin mr-2"></i> Loading...
            </div>`;
            lucide.createIcons();

            // Set title
            const tab = TOP_TABS.find(t => t.id === currentTopTab);
            const sideTab = SIDE_TABS[currentTopTab]?.find(t => t.id === currentSideTab);
            pageTitle.textContent = sideTab?.label || tab?.label || 'Dashboard';

            // Load based on current tab
            if (currentTopTab === 'dashboard') {
                await loadDashboardContent();
            } else if (!currentClient) {
                contentArea.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-gray-500">
                        <i data-lucide="folder-open" class="w-12 h-12 mb-4 text-gray-600"></i>
                        <p class="text-lg font-medium">Select a client to view data</p>
                        <p class="text-sm mt-1">Use the dropdown in the top right corner</p>
                    </div>`;
                pageActions.innerHTML = '';
            } else {
                await loadTabContent();
            }

            lucide.createIcons();
        }

        async function loadDashboardContent() {
            const contentArea = document.getElementById('contentArea');
            const pageActions = document.getElementById('pageActions');

            if (currentSideTab === 'overview') {
                pageActions.innerHTML = '';

                try {
                    const [campaignsRes, tasksRes] = await Promise.all([
                        fetch('/api/campaigns'),
                        fetch('/api/tasks')
                    ]);
                    const campaigns = (await campaignsRes.json()).campaigns || [];
                    const tasks = (await tasksRes.json()).tasks || [];

                    const stats = {
                        clients: campaigns.length,
                        pending: tasks.filter(t => t.status === 'pending').length,
                        inProgress: tasks.filter(t => t.status === 'in_progress').length,
                        completed: tasks.filter(t => t.status === 'done').length
                    };

                    contentArea.innerHTML = `
                        <div class="grid grid-cols-4 gap-4 mb-6">
                            <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 bg-blue-500/20 rounded-lg">
                                        <i data-lucide="building" class="w-5 h-5 text-blue-400"></i>
                                    </div>
                                    <div>
                                        <p class="text-2xl font-bold text-white">${stats.clients}</p>
                                        <p class="text-xs text-gray-400">Active Clients</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 bg-yellow-500/20 rounded-lg">
                                        <i data-lucide="clock" class="w-5 h-5 text-yellow-400"></i>
                                    </div>
                                    <div>
                                        <p class="text-2xl font-bold text-white">${stats.pending}</p>
                                        <p class="text-xs text-gray-400">Pending Tasks</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 bg-violet-500/20 rounded-lg">
                                        <i data-lucide="loader-2" class="w-5 h-5 text-violet-400"></i>
                                    </div>
                                    <div>
                                        <p class="text-2xl font-bold text-white">${stats.inProgress}</p>
                                        <p class="text-xs text-gray-400">In Progress</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 bg-emerald-500/20 rounded-lg">
                                        <i data-lucide="check-circle" class="w-5 h-5 text-emerald-400"></i>
                                    </div>
                                    <div>
                                        <p class="text-2xl font-bold text-white">${stats.completed}</p>
                                        <p class="text-xs text-gray-400">Completed</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-900 border border-gray-800 rounded-xl">
                            <div class="px-4 py-3 border-b border-gray-800 flex items-center justify-between">
                                <h3 class="text-sm font-semibold text-white">Recent Tasks</h3>
                                <button onclick="switchTopTab('tasks')" class="text-xs text-violet-400 hover:text-violet-300">View all →</button>
                            </div>
                            <div class="divide-y divide-gray-800">
                                ${tasks.length ? tasks.slice(0, 5).map(t => `
                                    <div class="px-4 py-3 flex items-center justify-between hover:bg-gray-800/30">
                                        <div class="flex items-center gap-3">
                                            <span class="w-2 h-2 rounded-full ${getStatusColor(t.status)}"></span>
                                            <span class="text-sm text-white">${t.title}</span>
                                        </div>
                                        <span class="text-xs px-2 py-1 rounded bg-gray-800 text-gray-400">${t.type}</span>
                                    </div>
                                `).join('') : '<p class="px-4 py-8 text-center text-gray-500">No tasks yet</p>'}
                            </div>
                        </div>
                    `;
                } catch (error) {
                    contentArea.innerHTML = `<div class="text-red-400">Error: ${error.message}</div>`;
                }
            } else if (currentSideTab === 'clients') {
                pageActions.innerHTML = `
                    <button onclick="showNewClientModal()" class="bg-violet-600 hover:bg-violet-500 text-white px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1.5">
                        <i data-lucide="plus" class="w-4 h-4"></i> New Client
                    </button>`;

                try {
                    const response = await fetch('/api/campaigns');
                    const { campaigns } = await response.json();

                    if (!campaigns?.length) {
                        contentArea.innerHTML = `
                            <div class="flex flex-col items-center justify-center h-64 text-center">
                                <i data-lucide="folder-plus" class="w-12 h-12 text-gray-600 mb-4"></i>
                                <h3 class="text-lg font-semibold text-white mb-2">No clients yet</h3>
                                <p class="text-gray-400 mb-4">Add your first client to get started</p>
                                <button onclick="showNewClientModal()" class="bg-violet-600 hover:bg-violet-500 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                    + Add Client
                                </button>
                            </div>`;
                    } else {
                        contentArea.innerHTML = `
                            <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden">
                                <table class="w-full">
                                    <thead class="bg-gray-900/50 text-xs uppercase text-gray-400 border-b border-gray-800">
                                        <tr>
                                            <th class="px-4 py-3 text-left font-medium">Client</th>
                                            <th class="px-4 py-3 text-left font-medium">Domain</th>
                                            <th class="px-4 py-3 text-left font-medium">Status</th>
                                            <th class="px-4 py-3 text-left font-medium">Created</th>
                                            <th class="px-4 py-3 text-right font-medium">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-800 text-sm">
                                        ${campaigns.map(c => `
                                            <tr class="hover:bg-gray-800/30 cursor-pointer" onclick="selectClient('${c.id}', true); switchTopTab('tech-audit');">
                                                <td class="px-4 py-3 font-medium text-white">${c.name}</td>
                                                <td class="px-4 py-3 text-gray-400">${c.domain}</td>
                                                <td class="px-4 py-3">
                                                    <span class="px-2 py-1 text-xs rounded ${c.status === 'active' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-gray-700 text-gray-400'}">${c.status}</span>
                                                </td>
                                                <td class="px-4 py-3 text-gray-500">${new Date(c.created_at).toLocaleDateString()}</td>
                                                <td class="px-4 py-3 text-right">
                                                    <button class="text-gray-400 hover:text-white">
                                                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>`;
                    }
                } catch (error) {
                    contentArea.innerHTML = `<div class="text-red-400">Error: ${error.message}</div>`;
                }
            } else if (currentSideTab === 'team') {
                pageActions.innerHTML = `
                    <button onclick="showInviteModal()" class="bg-violet-600 hover:bg-violet-500 text-white px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1.5">
                        <i data-lucide="user-plus" class="w-4 h-4"></i> Invite Member
                    </button>`;
                contentArea.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-center text-gray-500">
                        <i data-lucide="users" class="w-12 h-12 text-gray-600 mb-4"></i>
                        <p>Team management coming soon</p>
                    </div>`;
            } else if (currentSideTab === 'settings') {
                pageActions.innerHTML = '';
                contentArea.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-center text-gray-500">
                        <i data-lucide="settings" class="w-12 h-12 text-gray-600 mb-4"></i>
                        <p>Settings page coming soon</p>
                    </div>`;
            }

            lucide.createIcons();
        }

        async function loadTabContent() {
            const contentArea = document.getElementById('contentArea');
            const pageActions = document.getElementById('pageActions');

            // Placeholder for client-specific tabs
            pageActions.innerHTML = '';

            if (currentTopTab === 'tech-audit') {
                await loadAuditContent();
            } else if (currentTopTab === 'competitors') {
                await loadCompetitorContent();
            } else if (currentTopTab === 'client-settings') {
                await loadClientSettingsContent();
            } else {
                contentArea.innerHTML = `
                    <div class="bg-gray-900 border border-gray-800 rounded-xl p-8 text-center">
                        <i data-lucide="construction" class="w-12 h-12 text-gray-600 mx-auto mb-4"></i>
                        <h3 class="text-lg font-semibold text-white mb-2">${currentClient?.name || 'Client'} — ${currentSideTab.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h3>
                        <p class="text-gray-400">This section will show ${currentSideTab} data for ${currentClient?.domain || 'selected client'}.</p>
                        <p class="text-xs text-gray-500 mt-4">Implementation coming in Phase 2</p>
                    </div>`;
            }

            lucide.createIcons();
        }

        async function loadClientSettingsContent() {
            const contentArea = document.getElementById('contentArea');
            const pageActions = document.getElementById('pageActions');

            if (!currentClient) {
                contentArea.innerHTML = `<div class="text-center text-gray-500 py-12">Select a client to view settings</div>`;
                return;
            }

            // Fetch current settings
            let settings = currentClient.settings || {};

            pageActions.innerHTML = `
                <button onclick="saveClientSettings()" class="bg-violet-600 hover:bg-violet-500 text-white px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1.5">
                    <i data-lucide="save" class="w-4 h-4"></i> Save Settings
                </button>`;

            if (currentSideTab === 'general') {
                contentArea.innerHTML = `
                    <div class="max-w-2xl">
                        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6 mb-4">
                            <h3 class="text-lg font-semibold text-white mb-4">General Information</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">Client Name</label>
                                    <input type="text" id="setting_name" value="${currentClient.name || ''}" 
                                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-violet-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">Domain</label>
                                    <input type="text" id="setting_domain" value="${currentClient.domain || ''}" 
                                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-violet-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">Language</label>
                                    <select id="setting_language" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-violet-500 focus:outline-none">
                                        <option value="English" ${settings.language === 'English' ? 'selected' : ''}>English</option>
                                        <option value="Spanish" ${settings.language === 'Spanish' ? 'selected' : ''}>Spanish</option>
                                        <option value="French" ${settings.language === 'French' ? 'selected' : ''}>French</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">Location</label>
                                    <select id="setting_location" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-violet-500 focus:outline-none">
                                        <option value="US" ${settings.location === 'US' ? 'selected' : ''}>United States</option>
                                        <option value="UK" ${settings.location === 'UK' ? 'selected' : ''}>United Kingdom</option>
                                        <option value="IN" ${settings.location === 'IN' ? 'selected' : ''}>India</option>
                                        <option value="AU" ${settings.location === 'AU' ? 'selected' : ''}>Australia</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>`;
            } else if (currentSideTab === 'google') {
                contentArea.innerHTML = `
                    <div class="max-w-2xl">
                        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6 mb-4">
                            <h3 class="text-lg font-semibold text-white mb-2">Google Search Console</h3>
                            <p class="text-xs text-gray-400 mb-4">Property URL from GSC</p>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">GSC Property URL</label>
                                    <input type="text" id="setting_gsc_property" value="${settings.gsc_property || ''}" placeholder="https://example.com/"
                                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-violet-500 focus:outline-none">
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6 mb-4">
                            <h3 class="text-lg font-semibold text-white mb-2">Google Analytics 4</h3>
                            <p class="text-xs text-gray-400 mb-4">Your GA4 property ID</p>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">GA4 Property ID</label>
                                    <input type="text" id="setting_ga4_property" value="${settings.ga4_property || ''}" placeholder="123456789"
                                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-violet-500 focus:outline-none">
                                </div>
                            </div>
                        </div>
                    </div>`;
            } else if (currentSideTab === 'cms') {
                contentArea.innerHTML = `
                    <div class="max-w-2xl">
                        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6 mb-4">
                            <h3 class="text-lg font-semibold text-white mb-2">WordPress</h3>
                            <p class="text-xs text-gray-400 mb-4">REST API credentials for content publishing</p>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">WordPress URL</label>
                                    <input type="text" id="setting_wp_url" value="${settings.wp_url || ''}" placeholder="https://example.com"
                                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-violet-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">Username</label>
                                    <input type="text" id="setting_wp_user" value="${settings.wp_user || ''}" placeholder="admin"
                                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-violet-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">Application Password</label>
                                    <input type="password" id="setting_wp_app_password" value="${settings.wp_app_password || ''}" placeholder="xxxx xxxx xxxx xxxx"
                                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-violet-500 focus:outline-none">
                                    <p class="text-xs text-gray-500 mt-1">Generate from WordPress → Users → Your Profile → Application Passwords</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6 mb-4">
                            <h3 class="text-lg font-semibold text-white mb-2">Shopify (Optional)</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">Shopify Store URL</label>
                                    <input type="text" id="setting_shopify_store" value="${settings.shopify_store || ''}" placeholder="example.myshopify.com"
                                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-violet-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">Admin API Access Token</label>
                                    <input type="password" id="setting_shopify_token" value="${settings.shopify_token || ''}" placeholder="shpat_..."
                                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-violet-500 focus:outline-none">
                                </div>
                            </div>
                        </div>
                    </div>`;
            } else if (currentSideTab === 'analytics') {
                contentArea.innerHTML = `
                    <div class="max-w-2xl">
                        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6 mb-4">
                            <h3 class="text-lg font-semibold text-white mb-2">Microsoft Clarity</h3>
                            <p class="text-xs text-gray-400 mb-4">For heatmaps and session recordings</p>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Clarity Project ID</label>
                                <input type="text" id="setting_clarity_id" value="${settings.clarity_id || ''}" placeholder="abc123xyz"
                                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-violet-500 focus:outline-none">
                            </div>
                        </div>
                        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6 mb-4">
                            <h3 class="text-lg font-semibold text-white mb-2">Ahrefs (Optional)</h3>
                            <p class="text-xs text-gray-400 mb-4">For backlink and keyword data</p>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Ahrefs API Token</label>
                                <input type="password" id="setting_ahrefs_token" value="${settings.ahrefs_token || ''}" placeholder="API token"
                                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-violet-500 focus:outline-none">
                            </div>
                        </div>
                    </div>`;
            }

            lucide.createIcons();
        }

        async function saveClientSettings() {
            if (!currentClient) return;

            // Collect all settings from current page
            const settings = { ...currentClient.settings };

            // General
            const name = document.getElementById('setting_name');
            const domain = document.getElementById('setting_domain');
            const language = document.getElementById('setting_language');
            const location = document.getElementById('setting_location');

            if (language) settings.language = language.value;
            if (location) settings.location = location.value;

            // Google
            const gscProperty = document.getElementById('setting_gsc_property');
            const ga4Property = document.getElementById('setting_ga4_property');
            if (gscProperty) settings.gsc_property = gscProperty.value;
            if (ga4Property) settings.ga4_property = ga4Property.value;

            // CMS
            const wpUrl = document.getElementById('setting_wp_url');
            const wpUser = document.getElementById('setting_wp_user');
            const wpAppPassword = document.getElementById('setting_wp_app_password');
            const shopifyStore = document.getElementById('setting_shopify_store');
            const shopifyToken = document.getElementById('setting_shopify_token');
            if (wpUrl) settings.wp_url = wpUrl.value;
            if (wpUser) settings.wp_user = wpUser.value;
            if (wpAppPassword) settings.wp_app_password = wpAppPassword.value;
            if (shopifyStore) settings.shopify_store = shopifyStore.value;
            if (shopifyToken) settings.shopify_token = shopifyToken.value;

            // Analytics
            const clarityId = document.getElementById('setting_clarity_id');
            const ahrefsToken = document.getElementById('setting_ahrefs_token');
            if (clarityId) settings.clarity_id = clarityId.value;
            if (ahrefsToken) settings.ahrefs_token = ahrefsToken.value;

            // Competitors
            const competitorInputs = document.querySelectorAll('.competitor-input');
            if (competitorInputs.length) {
                settings.competitors = Array.from(competitorInputs).map(i => i.value).filter(v => v.trim());
            }

            // Prepare update data
            const updateData = { settings };
            if (name) updateData.name = name.value;
            if (domain) updateData.domain = domain.value;

            try {
                const res = await fetch(`/ api / campaigns / ${currentClient.id} `, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                if (res.ok) {
                    const { campaign } = await res.json();
                    // Update local state
                    currentClient = campaign;
                    const idx = clients.findIndex(c => c.id === campaign.id);
                    if (idx >= 0) clients[idx] = campaign;

                    showModal(`
                        <div class="p-6 text-center">
                            <div class="w-12 h-12 mx-auto mb-4 bg-emerald-500/20 rounded-full flex items-center justify-center">
                                <i data-lucide="check" class="w-6 h-6 text-emerald-400"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-white mb-2">Settings Saved</h3>
                            <p class="text-gray-400 text-sm mb-4">Client settings have been updated.</p>
                            <button onclick="hideModal()" class="bg-violet-600 hover:bg-violet-500 text-white px-4 py-2 rounded-lg text-sm font-medium">OK</button>
                        </div>
                    `);
                    lucide.createIcons();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Failed to save settings');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // =========================================================================
        // HELPERS
        // =========================================================================
        function getStatusColor(status) {
            const colors = { pending: 'bg-yellow-400', in_progress: 'bg-blue-400', review: 'bg-violet-400', done: 'bg-emerald-400' };
            return colors[status] || 'bg-gray-400';
        }

        // =========================================================================
        // MODALS
        // =========================================================================
        function showModal(content) {
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');
            lucide.createIcons();
        }

        function hideModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
            document.getElementById('modalOverlay').classList.remove('flex');
        }

        function showNewClientModal() {
            showModal(`
                    <div class="p-4 border-b border-gray-800 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-white">New Client</h3>
                    <button onclick="hideModal()" class="text-gray-400 hover:text-white">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                    <form onsubmit="createClient(event)" class="p-4 space-y-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Domain</label>
                            <input type="text" name="domain" required placeholder="example.com"
                                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-violet-500 focus:outline-none">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Language</label>
                                <select name="language" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-violet-500 focus:outline-none">
                                    <option value="English">English</option>
                                    <option value="Spanish">Spanish</option>
                                    <option value="French">French</option>
                                    <option value="German">German</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Location</label>
                                <select name="location" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-violet-500 focus:outline-none">
                                    <option value="US">United States</option>
                                    <option value="UK">United Kingdom</option>
                                    <option value="IN">India</option>
                                    <option value="AU">Australia</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Focus</label>
                            <select name="focus" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-violet-500 focus:outline-none">
                                <option value="Product">Product (E-commerce)</option>
                                <option value="Service">Service</option>
                                <option value="Local">Local Business</option>
                                <option value="SaaS">SaaS</option>
                            </select>
                        </div>
                        <div class="flex gap-3 pt-2">
                            <button type="button" onclick="hideModal()" class="flex-1 bg-gray-800 text-gray-300 px-4 py-2 rounded-lg text-sm hover:bg-gray-700">Cancel</button>
                            <button type="submit" class="flex-1 bg-violet-600 hover:bg-violet-500 text-white px-4 py-2 rounded-lg text-sm font-medium">Create</button>
                        </div>
                    </form>
                `);
        }

        function showUserSettingsModal() {
            showModal(`
                    <div class="p-4 border-b border-gray-800 flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-white">User Settings</h3>
                        <button onclick="hideModal()" class="text-gray-400 hover:text-white">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="p-6">
                        <h4 class="text-sm font-medium text-gray-300 mb-4">Change Password</h4>
                        <form onsubmit="changePassword(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Current Password</label>
                                <input type="password" name="current_password" required
                                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-violet-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">New Password</label>
                                <input type="password" name="new_password" required minlength="6"
                                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-violet-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Confirm New Password</label>
                                <input type="password" name="confirm_password" required minlength="6"
                                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-violet-500 focus:outline-none">
                            </div>
                            <div class="flex justify-end pt-4">
                                <button type="submit" class="bg-violet-600 hover:bg-violet-500 text-white px-4 py-2 rounded-lg text-sm font-medium">Update Password</button>
                            </div>
                        </form>
                    </div>
                `);
        }

        async function changePassword(e) {
            e.preventDefault();
            const form = e.target;
            const current_password = form.current_password.value;
            const new_password = form.new_password.value;
            const confirm_password = form.confirm_password.value;

            if (new_password !== confirm_password) {
                alert("New passwords do not match");
                return;
            }

            const btn = form.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = 'Updating...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ current_password, new_password })
                });

                const data = await res.json();

                if (res.ok) {
                    showModal(`
                        <div class="p-6 text-center">
                                <div class="w-12 h-12 mx-auto mb-4 bg-emerald-500/20 rounded-full flex items-center justify-center">
                                    <i data-lucide="check" class="w-6 h-6 text-emerald-400"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-white mb-2">Password Updated</h3>
                                <p class="text-gray-400 text-sm mb-4">Your password has been changed successfully.</p>
                                <button onclick="hideModal()" class="bg-violet-600 hover:bg-violet-500 text-white px-4 py-2 rounded-lg text-sm font-medium">OK</button>
                            </div>
                    `);
                    lucide.createIcons();
                } else {
                    alert('Error: ' + data.error);
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            } catch (error) {
                alert('Error: ' + error.message);
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function createClient(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                name: form.domain.value,
                domain: form.domain.value,
                settings: {
                    language: form.language.value,
                    location: form.location.value,
                    focus: form.focus.value
                }
            };

            try {
                const res = await fetch('/api/campaigns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    hideModal();
                    await loadClients();
                    loadContent();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Failed to create client');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function runAudit() {
            if (!currentClient) {
                alert('Please select a client first');
                return;
            }

            try {
                const res = await fetch('/api/audits', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        campaign_id: currentClient.id,
                        type: 'technical'
                    })
                });

                if (res.ok) {
                    showModal(`
                        showModal(`
                        <div class="p-6 text-center" >
                            <div class="w-12 h-12 mx-auto mb-4 bg-violet-500/20 rounded-full flex items-center justify-center">
                                <i data-lucide="loader-2" class="w-6 h-6 text-violet-400 animate-spin"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-white mb-2">Audit Started</h3>
                            <p class="text-gray-400 text-sm mb-4">Running technical audit for ${currentClient.domain}...</p>
                            <button onclick="hideModal()" class="bg-violet-600 hover:bg-violet-500 text-white px-4 py-2 rounded-lg text-sm font-medium">OK</button>
                        </div>
                        `);
                    lucide.createIcons();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Failed to start audit');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function showInviteModal() {
            showModal(`
                        <div class="p-4 border-b border-gray-800" >
                        <h3 class="text-lg font-semibold text-white">Invite Team Member</h3>
                </div>
                        <div class="p-4 text-center text-gray-400">
                            <p>Team invites coming soon</p>
                        </div>
                `);
        }

        // =========================================================================
        // AUTH
        // =========================================================================
        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/login.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Click outside modal to close
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'modalOverlay') hideModal();
        });

        // =========================================================================
        // AUDIT FUNCTIONS
        // =========================================================================
        async function loadAuditContent() {
            const contentArea = document.getElementById('contentArea');
            const pageActions = document.getElementById('pageActions');

            pageActions.innerHTML = `
                        <button onclick = "runAudit()" class="bg-violet-600 hover:bg-violet-500 text-white px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1.5" >
                        <i data-lucide="play" class="w-4 h-4"></i> Run Audit
                </button> `;

            if (currentSideTab === 'url-inspection') {
                // Determine if we show list or "Back to list"
                if (activeAudit) {
                    // If user clicks "URL Inspection" while viewing an audit, reset view? 
                    // Or keep showing list? Let's show list but maybe indicate active one.
                    // For now, simple: viewing URL Inspection clears active audit
                    activeAudit = null;
                }
            }

            // If we have an active audit and are on a relevant tab, show details
            if (activeAudit && ['on-page', 'technical-issues', 'core-vitals', 'schema', 'page-speed'].includes(currentSideTab)) {
                renderAuditDetail();
                return;
            }

            if (currentSideTab !== 'url-inspection') {
                contentArea.innerHTML = `
                        <div class="bg-gray-900 border border-gray-800 rounded-xl p-8 text-center" >
                        <i data-lucide="construction" class="w-12 h-12 text-gray-600 mx-auto mb-4"></i>
                        <h3 class="text-lg font-semibold text-white mb-2">${currentSideTab.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h3>
                        <p class="text-gray-400">This specific report is coming soon.</p>
                    </div> `;
                lucide.createIcons();
                return;
            }

            try {
                const response = await fetch(`/ api / audits ? campaign_id = ${ currentClient.id } `);
                const data = await response.json();
                const audits = data.audits || [];

                if (audits.length === 0) {
                    contentArea.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-center" >
                            <i data-lucide="search-check" class="w-12 h-12 text-gray-600 mb-4"></i>
                            <h3 class="text-lg font-semibold text-white mb-2">No audits yet</h3>
                            <p class="text-gray-400 mb-4">Run your first technical audit for ${currentClient.domain}</p>
                            <button onclick="runAudit()" class="bg-violet-600 hover:bg-violet-500 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                Run Audit
                            </button>
                        </div> `;
                } else {
                    contentArea.innerHTML = `
                        <div class="grid gap-4" >
                        ${
                        audits.map(audit => {
                            const isCrawling = audit.status === 'crawling' || audit.status === 'running';
                            const statusColor = isCrawling ? 'text-yellow-400' : (audit.status === 'completed' ? 'text-emerald-400' : 'text-red-400');
                            const statusIcon = isCrawling ? 'loader-2' : (audit.status === 'completed' ? 'check-circle' : 'alert-circle');

                            return `
                                <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <div class="p-2 bg-gray-800 rounded-lg">
                                            <i data-lucide="${statusIcon}" class="w-6 h-6 ${statusColor} ${isCrawling ? 'animate-spin' : ''}"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-medium text-white">Full Site Audit</h4>
                                            <div class="flex items-center gap-3 text-sm text-gray-400 mt-1">
                                                <span>${new Date(audit.created_at).toLocaleString()}</span>
                                                <span>•</span>
                                                <span class="${statusColor} capitalize">${audit.status}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        ${isCrawling ? `
                                            <button onclick="checkAuditStatus('${audit.id}')" class="text-gray-400 hover:text-white flex items-center gap-1 text-sm bg-gray-800 px-3 py-1.5 rounded-lg border border-gray-700">
                                                <i data-lucide="refresh-cw" class="w-3 h-3"></i> Check Status
                                            </button>
                                        ` : `
                                            <button onclick="viewAuditResults('${audit.id}')" class="bg-gray-800 hover:bg-gray-700 text-white px-3 py-1.5 rounded-lg text-sm font-medium border border-gray-700">
                                                View Results
                                            </button>
                                        `}
                                    </div>
                                </div>`;
                        }).join('')
                    }
                        </div> `;
                }
            } catch (error) {
                contentArea.innerHTML = `<div class="text-red-400" > Error loading audits: ${ error.message }</div> `;
            }
            lucide.createIcons();
        }

        async function runAudit() {
            if (!confirm('Start a new comprehensive technical audit? This usually takes 2-5 minutes.')) return;

            const btn = document.querySelector('button[onclick="runAudit()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin" ></i> Starting...`;
            btn.disabled = true;

            try {
                const response = await fetch('/api/audits', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        campaign_id: currentClient.id,
                        type: 'technical'
                    })
                });

                if (!response.ok) throw new Error('Failed to start audit');

                await loadAuditContent(); // Refresh list
            } catch (error) {
                alert('Error: ' + error.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function checkAuditStatus(auditId) {
            try {
                const response = await fetch(`/ api / audits / ${ auditId } `);
                const data = await response.json();

                if (data.audit && data.audit.status === 'completed') {
                    // It finished! Reload list to show "View Results"
                    await loadAuditContent();
                } else {
                    // Still running, maybe show a toast
                    const btn = document.querySelector(`button[onclick = "checkAuditStatus('${auditId}')"]`);
                    if (btn) {
                        const original = btn.innerHTML;
                        btn.innerHTML = `<i data-lucide="check" class="w-3 h-3 text-emerald-400" ></i> Still running...`;
                        setTimeout(() => btn.innerHTML = original, 2000);
                    }
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function viewAuditResults(auditId) {
            try {
                // Show loading state
                const btn = document.querySelector(`button[onclick = "viewAuditResults('${auditId}')"]`);
                if (btn) btn.innerHTML = `<i data-lucide="loader-2" class="w-3 h-3 animate-spin" ></i> Loading...`;

                const response = await fetch(`/ api / audits / ${ auditId } `);
                const data = await response.json();

                if (data.audit) {
                    activeAudit = data.audit;
                    // Switch to On-Page Report tab
                    switchSideTab('on-page');
                }
            } catch (e) {
                console.error(e);
                alert('Failed to load audit results');
            }
        }

        // =========================================================================
        // COMPETITOR FUNCTIONS
        // =========================================================================
        async function loadCompetitorContent() {
            const contentArea = document.getElementById('contentArea');
            const pageActions = document.getElementById('pageActions');

            pageActions.innerHTML = ''; // Clear actions

            if (currentSideTab !== 'overview') {
                contentArea.innerHTML = `
                    <div class="bg-gray-900 border border-gray-800 rounded-xl p-8 text-center" >
                        <i data-lucide="construction" class="w-12 h-12 text-gray-600 mx-auto mb-4"></i>
                        <h3 class="text-lg font-semibold text-white mb-2">${currentSideTab.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h3>
                        <p class="text-gray-400">Deep gap analysis and content library features coming in Phase 3.</p>
                    </div> `;
                lucide.createIcons();
                return;
            }

            // Get cached data if available
            const comps = currentClient.settings?.competitors || [];
            const lastAnalysis = currentClient.settings?.last_competitor_analysis || null;

            let tableHtml = '';

            if (lastAnalysis) {
                const target = lastAnalysis.target;
                const compStats = lastAnalysis.competitors;

                tableHtml = `
                        <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden mb-8" >
                        <div class="p-4 border-b border-gray-800 flex justify-between items-center">
                            <h3 class="font-medium text-white">Share of Voice & Traffic Estimation</h3>
                            <span class="text-xs text-gray-500">Last updated: ${new Date(lastAnalysis.analyzed_at).toLocaleString()}</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-gray-400">
                                <thead class="bg-gray-900/50 text-gray-500 font-medium border-b border-gray-800">
                                    <tr>
                                        <th class="p-4">Domain</th>
                                        <th class="p-4 text-right">Organic Keywords</th>
                                        <th class="p-4 text-right">Est. Monthly Traffic</th>
                                        <th class="p-4 text-right">Market Share</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-800">
                                    <!-- Target -->
                                    <tr class="bg-violet-500/5 hover:bg-violet-500/10 transition-colors">
                                        <td class="p-4 font-medium text-white flex items-center gap-2">
                                            <div class="w-2 h-2 rounded-full bg-violet-500"></div>
                                            ${target.domain}
                                            <span class="text-xs bg-violet-500/20 text-violet-300 px-2 py-0.5 rounded ml-2">You</span>
                                        </td>
                                        <td class="p-4 text-right font-mono text-white">${target.organic_keywords.toLocaleString()}</td>
                                        <td class="p-4 text-right font-mono text-white">${target.estimated_traffic.toLocaleString()}</td>
                                        <td class="p-4 text-right text-gray-300">-</td>
                                    </tr>
                                    <!-- Competitors -->
                                    ${compStats.map(c => `
                                    <tr class="hover:bg-gray-800/50 transition-colors">
                                        <td class="p-4 font-medium text-gray-300">${c.domain}</td>
                                        <td class="p-4 text-right font-mono">${c.organic_keywords.toLocaleString()}</td>
                                        <td class="p-4 text-right font-mono">${c.estimated_traffic.toLocaleString()}</td>
                                        <td class="p-4 text-right text-gray-500">
                                            ${target.estimated_traffic > 0 ? ((c.estimated_traffic / target.estimated_traffic) * 100).toFixed(1) + '%' : 'N/A'} 
                                            <span class="text-xs">vs you</span>
                                        </td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                        `;
            }

            contentArea.innerHTML = `
                        <div class="max-w-4xl mx-auto" >
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h2 class="text-2xl font-bold text-white mb-2">Competitor Analysis</h2>
                            <p class="text-gray-400">Compare ${currentClient.domain} against top market rivals.</p>
                        </div>
                        <button onclick="runCompetitorAnalysis()" class="bg-violet-600 hover:bg-violet-500 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                            <i data-lucide="zap" class="w-4 h-4"></i> Run Analysis
                        </button>
                    </div>

                    <div class="bg-gray-900 border border-gray-800 rounded-xl p-6 mb-8">
                        <label class="block text-sm font-medium text-gray-300 mb-3">Competitor Domains</label>
                        <div class="space-y-3" id="competitorInputs">
                            ${[0, 1, 2].map(i => `
                                <div class="flex items-center gap-3">
                                    <div class="bg-gray-800 h-10 w-10 rounded-lg flex items-center justify-center text-gray-500 text-sm font-medium">${i + 1}</div>
                                    <input type="text" 
                                           class="competitor-input bg-black border border-gray-800 text-white text-sm rounded-lg focus:ring-violet-500 focus:border-violet-500 block w-full p-2.5" 
                                           placeholder="competitor${i + 1}.com"
                                           value="${comps[i] || ''}">
                                </div>
                            `).join('')}
                        </div>
                        <p class="text-xs text-gray-500 mt-3">Enter up to 3 main competitors (e.g., 'moz.com').</p>
                    </div>

                    ${ tableHtml }
                    
                    ${!lastAnalysis ? `
                        <div class="text-center py-12 border border-dashed border-gray-800 rounded-xl">
                            <i data-lucide="bar-chart-2" class="w-12 h-12 text-gray-700 mx-auto mb-3"></i>
                            <p class="text-gray-500">No analysis run yet. Add competitors and hit "Run Analysis".</p>
                        </div>` : ''
                }
                </div>
                    `;
            lucide.createIcons();
        }

        async function runCompetitorAnalysis() {
            const inputs = document.querySelectorAll('.competitor-input');
            const competitors = Array.from(inputs).map(i => i.value.trim()).filter(v => v);

            if (competitors.length === 0) {
                alert('Please enter at least one competitor domain.');
                return;
            }

            const btn = document.querySelector('button[onclick="runCompetitorAnalysis()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin" ></i> Analyzing...`;
            btn.disabled = true;

            try {
                const response = await fetch('/api/competitors/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        campaign_id: currentClient.id,
                        competitors: competitors
                    })
                });

                const data = await response.json();

                if (!response.ok) throw new Error(data.error || 'Analysis failed');

                // Reload client data to get updated settings
                const clientRes = await fetch(`/ api / campaigns / ${ currentClient.id } `);
                const clientData = await clientRes.json();
                currentClient = clientData.campaign;

                // Refresh content
                await loadCompetitorContent();

            } catch (error) {
                alert('Error: ' + error.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function generateSlides(auditId) {
            const btn = document.getElementById(`btn - slides - ${ auditId } `);
            if (btn) {
                btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin" ></i> Generating...`;
                btn.disabled = true;
                lucide.createIcons();
            }

            try {
                const response = await fetch(`/ api / audits / ${ auditId }/generate-slides`, { method: 'POST' });
                const data = await response.json();

                if (!response.ok) throw new Error(data.error || 'Failed to generate slides');

                // Update local model
                activeAudit.slides_url = data.slides_url;

                // Re-render header to show specific view button
                renderAuditDetail();

                window.open(data.slides_url, '_blank');

            } catch (error) {
                alert('Error: ' + error.message);
                if (btn) {
                    btn.innerHTML = `<i data-lucide="presentation" class="w-4 h-4"></i> Generate Slides`;
                    btn.disabled = false;
                    lucide.createIcons();
                }
            }
        }

        function renderAuditDetail() {
            const contentArea = document.getElementById('contentArea');
            const summary = activeAudit.results?.summary || activeAudit.summary || {};
            const pages = activeAudit.results?.pages || [];

            // Back button
            const pageActions = document.getElementById('pageActions');
            pageActions.innerHTML = `
                <div class="flex items-center gap-3">
                    <button onclick="activeAudit=null; switchSideTab('url-inspection')" class="text-gray-400 hover:text-white text-sm flex items-center gap-1">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Audits
                    </button>
                    <div class="h-4 w-px bg-gray-700"></div>
                    <span class="text-sm text-gray-400">Viewing Audit: ${new Date(activeAudit.created_at).toLocaleDateString()}</span>
                    
                    ${activeAudit.slides_url ?
                    `<a href="${activeAudit.slides_url}" target="_blank" class="bg-violet-600 hover:bg-violet-500 text-white px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1.5 ml-2">
                            <i data-lucide="presentation" class="w-4 h-4"></i> View Slides
                        </a>` :
                    `<button id="btn-slides-${activeAudit.id}" onclick="generateSlides('${activeAudit.id}')" class="bg-gray-800 hover:bg-gray-700 text-white px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1.5 ml-2 border border-gray-700">
                             <i data-lucide="presentation" class="w-4 h-4"></i> Generate Slides
                         </button>`
                }
                </div>`;

            if (currentSideTab === 'on-page') {
                contentArea.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-gray-900 border border-gray-800 p-4 rounded-xl">
                            <h4 class="text-gray-400 text-xs uppercase font-semibold mb-2">On-Page Score</h4>
                            <div class="text-3xl font-bold text-white">${summary.onpage_score ? summary.onpage_score.toFixed(0) : '-'}</div>
                        </div>
                         <div class="bg-gray-900 border border-gray-800 p-4 rounded-xl">
                            <h4 class="text-gray-400 text-xs uppercase font-semibold mb-2">Pages Crawled</h4>
                            <div class="text-3xl font-bold text-white">${summary.pages_crawled || 0}</div>
                        </div>
                        <div class="bg-gray-900 border border-gray-800 p-4 rounded-xl">
                            <h4 class="text-gray-400 text-xs uppercase font-semibold mb-2">Critical Errors</h4>
                            <div class="text-3xl font-bold text-red-500">${summary.critical_issues_count || 0}</div>
                        </div>
                         <div class="bg-gray-900 border border-gray-800 p-4 rounded-xl">
                            <h4 class="text-gray-400 text-xs uppercase font-semibold mb-2">Warnings</h4>
                            <div class="text-3xl font-bold text-yellow-500">${summary.warnings_count || 0}</div>
                        </div>
                    </div>

                    <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden">
                        <div class="p-4 border-b border-gray-800">
                             <h3 class="font-medium text-white">Crawled Pages</h3>
                        </div>
                         <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-gray-400">
                                <thead class="bg-gray-900/50 text-gray-500 font-medium border-b border-gray-800">
                                    <tr>
                                        <th class="p-3">URL</th>
                                        <th class="p-3">Status</th>
                                        <th class="p-3 text-right">Score</th>
                                        <th class="p-3 text-right">Load Time</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-800">
                                    ${pages.slice(0, 50).map(p => `
                                    <tr>
                                        <td class="p-3 max-w-md truncate text-white" title="${p.url}">${p.url}</td>
                                        <td class="p-3"><span class="px-2 py-0.5 rounded text-xs ${p.status_code >= 400 ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}">${p.status_code}</span></td>
                                        <td class="p-3 text-right">${p.onpage_score || '-'}</td>
                                        <td class="p-3 text-right">${p.time_to_interactive ? p.time_to_interactive + 'ms' : '-'}</td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else if (currentSideTab === 'technical-issues') {
                // Group issues
                const issueMap = new Map();
                pages.forEach(p => {
                    const issues = p.issues || {};
                    Object.keys(issues).forEach(k => {
                        if (issues[k]) {
                            if (!issueMap.has(k)) issueMap.set(k, []);
                            issueMap.get(k).push(p.url);
                        }
                    });
                });

                contentArea.innerHTML = `
                     <div class="grid gap-4">
                        ${Array.from(issueMap.entries()).map(([issue, urls]) => `
                        <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-medium text-white capitalize">${issue.replace(/_/g, ' ')}</h4>
                                <span class="px-2 py-0.5 rounded text-xs bg-red-500/20 text-red-400 font-mono">${urls.length} pages</span>
                            </div>
                            <div class="bg-black/30 rounded-lg p-3 text-xs font-mono text-gray-500 max-h-32 overflow-y-auto">
                                ${urls.map(u => `<div class="truncate">${u}</div>`).join('')}
                            </div>
                        </div>
                        `).join('')}
                        ${issueMap.size === 0 ? '<div class="text-center py-12 text-gray-500">No issues found! Great job.</div>' : ''}
                     </div>
                `;
            } else if (currentSideTab === 'core-vitals') {
                // Calculate basic metrics from pages
                let fast = 0, moderate = 0, slow = 0;
                let totalLoad = 0;
                let count = 0;

                pages.forEach(p => {
                    const t = p.time_to_interactive || 0;
                    if (t > 0) {
                        totalLoad += t;
                        count++;
                        if (t < 2500) fast++;
                        else if (t < 4000) moderate++;
                        else slow++;
                    }
                });

                const avgLoad = count > 0 ? (totalLoad / count).toFixed(0) : 0;

                contentArea.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="bg-gray-900 border border-gray-800 p-6 rounded-xl text-center">
                            <div class="w-12 h-12 mx-auto bg-green-500/10 rounded-full flex items-center justify-center mb-4">
                                <i data-lucide="zap" class="w-6 h-6 text-green-500"></i>
                            </div>
                            <h4 class="text-gray-400 text-sm font-medium mb-1">Avg Load Time</h4>
                            <div class="text-3xl font-bold text-white">${avgLoad}ms</div>
                            <p class="text-xs text-gray-500 mt-2">Time to Interactive</p>
                        </div>
                        <div class="bg-gray-900 border border-gray-800 p-6 rounded-xl text-center">
                            <div class="w-12 h-12 mx-auto bg-blue-500/10 rounded-full flex items-center justify-center mb-4">
                                <i data-lucide="activity" class="w-6 h-6 text-blue-500"></i>
                            </div>
                            <h4 class="text-gray-400 text-sm font-medium mb-1">Performance Score</h4>
                            <div class="text-3xl font-bold text-white">${summary.onpage_score ? summary.onpage_score.toFixed(0) : '-'}</div>
                            <p class="text-xs text-gray-500 mt-2">On-Page Score</p>
                        </div>
                         <div class="bg-gray-900 border border-gray-800 p-6 rounded-xl text-center">
                            <div class="w-12 h-12 mx-auto bg-purple-500/10 rounded-full flex items-center justify-center mb-4">
                                <i data-lucide="layers" class="w-6 h-6 text-purple-500"></i>
                            </div>
                            <h4 class="text-gray-400 text-sm font-medium mb-1">Total Pages</h4>
                            <div class="text-3xl font-bold text-white">${pages.length}</div>
                            <p class="text-xs text-gray-500 mt-2">Analyzed</p>
                        </div>
                    </div>

                    <h3 class="font-medium text-white mb-4">Performance Distribution</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                         <div class="bg-gray-900 border border-gray-800 p-4 rounded-xl flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-3 h-3 rounded-full bg-green-500"></div>
                                <span class="text-gray-300">Fast (< 2.5s)</span>
                            </div>
                            <span class="text-xl font-bold text-white">${fast}</span>
                        </div>
                         <div class="bg-gray-900 border border-gray-800 p-4 rounded-xl flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                                <span class="text-gray-300">Moderate (2.5s - 4s)</span>
                            </div>
                            <span class="text-xl font-bold text-white">${moderate}</span>
                        </div>
                         <div class="bg-gray-900 border border-gray-800 p-4 rounded-xl flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-3 h-3 rounded-full bg-red-500"></div>
                                <span class="text-gray-300">Slow (> 4s)</span>
                            </div>
                            <span class="text-xl font-bold text-white">${slow}</span>
                        </div>
                    </div>
                `;

            } else if (currentSideTab === 'page-speed') {
                // Similar to CWV but focus on resources/size if available, else just load time table
                contentArea.innerHTML = `
                    <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden">
                        <div class="p-4 border-b border-gray-800 flex justify-between items-center">
                             <h3 class="font-medium text-white">Page Speed Analysis</h3>
                             <span class="text-xs text-gray-500">Sorted by Slowest</span>
                        </div>
                         <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-gray-400">
                                <thead class="bg-gray-900/50 text-gray-500 font-medium border-b border-gray-800">
                                    <tr>
                                        <th class="p-3">URL</th>
                                        <th class="p-3 text-right">Time to Interactive</th>
                                        <th class="p-3 text-right">Status</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-800">
                                    ${pages
                        .sort((a, b) => (b.time_to_interactive || 0) - (a.time_to_interactive || 0))
                        .slice(0, 50).map(p => {
                            const t = p.time_to_interactive || 0;
                            const color = t < 2500 ? 'text-green-400' : (t < 4000 ? 'text-yellow-400' : 'text-red-400');
                            return `
                                    <tr>
                                        <td class="p-3 max-w-md truncate text-white" title="${p.url}">${p.url}</td>
                                        <td class="p-3 text-right font-mono ${color}">${t} ms</td>
                                        <td class="p-3 text-right">
                                            <span class="px-2 py-0.5 rounded text-xs ${t < 2500 ? 'bg-green-500/20 text-green-400' : (t < 4000 ? 'bg-yellow-500/20 text-yellow-400' : 'bg-red-500/20 text-red-400')}">
                                                ${t < 2500 ? 'Good' : (t < 4000 ? 'Needs Improvement' : 'Poor')}
                                            </span>
                                        </td>
                                    </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else if (currentSideTab === 'schema') {
                // Placeholder for now as we don't have deep schema data in basic page objects yet
                contentArea.innerHTML = `
                    <div class="bg-gray-900 border border-gray-800 rounded-xl p-8 text-center">
                        <i data-lucide="code-2" class="w-12 h-12 text-gray-600 mx-auto mb-4"></i>
                        <h3 class="text-lg font-semibold text-white mb-2">Schema Analysis</h3>
                        <p class="text-gray-400 max-w-md mx-auto mb-6">Detailed Schema.org validation requires the advanced extraction pipeline. Currently verifying basic metadata presence.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left max-w-2xl mx-auto">
                            ${pages.slice(0, 6).map(p => `
                                <div class="bg-black/30 p-3 rounded-lg border border-gray-800">
                                    <div class="text-white truncate text-sm mb-1">${p.url}</div>
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="check-circle" class="w-3 h-3 text-green-500"></i>
                                        <span class="text-xs text-gray-500">Basic Meta Tags found</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;

            } else {
                contentArea.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-center text-gray-500">
                        <i data-lucide="bar-chart" class="w-12 h-12 text-gray-600 mb-4"></i>
                        <p>Detailed view for this section is coming soon.</p>
                    </div>`;
            }
            lucide.createIcons();
        }

        // Start
        init();
    </script>
</body>

</html>